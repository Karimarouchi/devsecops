import json
import os

def safe_read(path):
    if os.path.exists(path):
        with open(path, "r") as f:
            return f.read()
    return None


def parse_semgrep(path):
    data = json.loads(safe_read(path))

    if "errors" in data and data["errors"]:
        return [{
            "type": "Erreur Semgrep",
            "message": data["errors"][0]["message"],
            "file": "Rule file",
            "line": "-"
        }]

    findings = []
    for r in data.get("results", []):
        findings.append({
            "file": r["path"],
            "line": r["start"]["line"],
            "message": r["extra"]["message"],
            "severity": r["extra"].get("severity", "N/A")
        })
    return findings


def parse_trivy(path):
    data = json.loads(safe_read(path))
    findings = []
    for result in data.get("Results", []):
        for vuln in result.get("Vulnerabilities", []):
            findings.append({
                "id": vuln["VulnerabilityID"],
                "severity": vuln["Severity"],
                "package": vuln.get("PkgName"),
                "installed": vuln.get("InstalledVersion"),
                "fixed": vuln.get("FixedVersion", "N/A")
            })
    return findings



html = """
<h1>ğŸ” DevSecOps â€“ Security Report</h1>
"""

semgrep = parse_semgrep("reports/semgrep-report/semgrep.json")
trivy = parse_trivy("reports/trivy-report/trivy.json")

# --- Semgrep section ---
html += "<h2>ğŸ” SAST - Semgrep</h2>"
if semgrep:
    for s in semgrep:
        html += f"""
        <div>
        <b>Fichier :</b> {s['file']}<br>
        <b>Ligne :</b> {s['line']}<br>
        <b>ProblÃ¨me :</b> {s['message']}<br><br>
        </div>
        """
else:
    html += "<p>Aucun problÃ¨me dÃ©tectÃ©.</p>"

# --- Trivy section ---
html += "<h2>ğŸ³ Docker Scan - Trivy</h2>"
if trivy:
    for t in trivy:
        html += f"""
        <div>
        <b>ID :</b> {t['id']}<br>
        <b>Package :</b> {t['package']}<br>
        <b>Inst. :</b> {t['installed']} â€” <b>Fix:</b> {t['fixed']}<br>
        <b>Severity :</b> {t['severity']}<br><br>
        </div>
        """
else:
    html += "<p>Aucune vulnÃ©rabilitÃ© critique trouvÃ©e.</p>"


with open("security-dashboard.html", "w") as f:
    f.write(html)

print("Dashboard generated correctly.")

