name: "üîê DevSecOps - Full Security Pipeline"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  security-events: write
  pull-requests: write
  checks: write

jobs:

  #----------------------------------------------------
  # 1) SAST ‚Äî SEMGREP
  #----------------------------------------------------
  sast:
    name: "üîç SAST - Semgrep"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep --config=.semgrep/java-security-rules.yml \
                  --json -o semgrep.json || true

      - name: Check Semgrep findings
        run: |
          if grep -q '"check_id"' semgrep.json; then
            echo "‚ùå Semgrep vulnerabilities found!"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.json


  #----------------------------------------------------
  # 2) SCA ‚Äî DEPENDENCY CHECK
  #----------------------------------------------------
  sca:
    needs: sast
    name: "üß© SCA - Dependency Check"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install Dependency Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.3/dependency-check-10.0.3-release.zip
          unzip dependency-check-10.0.3-release.zip
          mv dependency-check /opt/dependency-check
          chmod +x /opt/dependency-check/bin/dependency-check.sh
          mkdir -p ${{ github.workspace }}/dep-report

      - name: Run Dependency Check
        run: |
          /opt/dependency-check/bin/dependency-check.sh \
            --nvdApiKey ${{ secrets.NVD_API_KEY }} \
            --project "DevSecOps" \
            --scan ./ \
            --format "ALL" \
            --out ${{ github.workspace }}/dep-report || true

      - name: Check CRITICAL findings
        run: |
          if grep -q "CRITICAL" ${{ github.workspace }}/dep-report/dependency-check-report.html; then
            echo "‚ùå Critical dependencies found!"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: ${{ github.workspace }}/dep-report


  #----------------------------------------------------
  # 3) SECRETS SCAN ‚Äî GITLEAKS
  #----------------------------------------------------
  secrets:
    needs: sca
    name: "üîí Secrets Scan - Gitleaks"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --report-format json --report-path gitleaks.json || true

      - name: Fail on secrets found
        run: |
          if grep -q '"Description"' gitleaks.json; then
            echo "‚ùå Secrets detected!"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks.json


  #----------------------------------------------------
  # 4) DOCKER ‚Äî TRIVY SCAN
  #----------------------------------------------------
  docker_scan:
    needs: secrets
    name: "üê≥ Trivy Docker Scan"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: docker build -t devsecops:latest .

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "devsecops:latest"
          format: "json"
          output: "trivy.json"
          exit-code: "0"

      - name: Fail on CRITICAL Docker findings
        run: |
          if grep -q "CRITICAL" trivy.json; then
            echo "‚ùå Critical Docker vulnerabilities detected!"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy.json


  #----------------------------------------------------
  # 5) DAST ‚Äî NIKTO
  #----------------------------------------------------
  dast:
    needs: docker_scan
    name: "üåê DAST - Nikto Scan"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Nikto scan
        run: |
          sudo apt update -qq
          sudo apt install -y nikto
          nikto -h http://testphp.vulnweb.com -o nikto.txt

      - uses: actions/upload-artifact@v4
        with:
          name: nikto-report
          path: nikto.txt


  #----------------------------------------------------
  # 6) QODANA ‚Äî CLOUD SCAN
  #----------------------------------------------------
  qodana:
    needs: dast
    name: "üîç Qodana Cloud"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Qodana
        uses: JetBrains/qodana-action@v2025.2
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN_800884080 }}
          QODANA_ENDPOINT: "https://qodana.cloud"


  #----------------------------------------------------
  # 7) EMAIL NOTIFICATION ON FAILURE
  #----------------------------------------------------
  notify_email:
    needs: [sast, sca, secrets, docker_scan, dast, qodana]
    if: failure()
    runs-on: ubuntu-latest
    name: "üìß Pipeline Failure Email"

    steps:
      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® DevSecOps Pipeline Failed"
          body: |
            ‚ö†Ô∏è Un scan de s√©curit√© a √©chou√© dans la pipeline DevSecOps.

            Consulte les logs GitHub Actions :
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ‚Äî DevSecOps Automated Security System
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}

