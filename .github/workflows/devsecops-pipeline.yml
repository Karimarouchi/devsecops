name: "üîê DevSecOps - Full Security Pipeline"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  security-events: write
  pull-requests: write
  checks: write

jobs:

  #----------------------------------------------------
  # 1) SAST ‚Äî SEMGREP
  #----------------------------------------------------
  sast:
    name: "üîç SAST - Semgrep"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep --config=.semgrep/java-security-rules.yml \
                  --json -o semgrep.json || true

      - uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.json

  #----------------------------------------------------
  # 2) CI ‚Äî BUILD & TEST MAVEN (VERSION CORRIG√âE)
  #----------------------------------------------------
  build:
    name: "‚öôÔ∏è CI - Build & Unit Tests"
    needs: sast
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Cache Maven
        id: cache-maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: m2-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: m2-${{ runner.os }}-

      # D√©terminer le statut du cache (OK / MISS)
      - name: Detect cache status
        run: |
          if [ "${{ steps.cache-maven.outputs.cache-hit }}" = "true" ]; then
            echo "OK" > cache_status
          else
            echo "MISS" > cache_status
          fi

      # Compilation
      - name: Compile project
        run: |
          mvn -B -q compile && echo "OK" > compile_status || echo "FAIL" > compile_status

      # Tests unitaires
      - name: Run unit tests
        run: |
          mvn -q test && echo "OK" > tests_status || echo "FAIL" > tests_status

      # Build du JAR
      - name: Package artifact
        run: |
          mvn -q package && echo "OK" > artifact_status || echo "FAIL" > artifact_status

      # G√©n√©rer le rapport CI JSON
      - name: Save CI status
        run: |
          mkdir -p reports/ci-status
          echo "{ \
            \"compile\":\"$(cat compile_status)\", \
            \"tests\":\"$(cat tests_status)\", \
            \"artifact\":\"$(cat artifact_status)\", \
            \"cache\":\"$(cat cache_status)\", \
            \"cleanup\":\"OK\" \
          }" > reports/ci-status/status.json

      # Upload JAR
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: target/*.jar

      # Upload CI JSON
      - name: Upload CI status
        uses: actions/upload-artifact@v4
        with:
          name: ci-status
          path: reports/ci-status/status.json

  #----------------------------------------------------
  # 3) SCA ‚Äî TRIVY FILESYSTEM SCAN
  #----------------------------------------------------
  sca:
    name: "üß© SCA - Trivy FS Scan"
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      - name: Run Trivy FS scan
        run: trivy fs . --format json --output trivy-sca.json || true

      - uses: actions/upload-artifact@v4
        with:
          name: sca-report
          path: trivy-sca.json


  #----------------------------------------------------
  # 4) SECRETS SCAN ‚Äî TRUFFLEHOG
  #----------------------------------------------------
  secrets:
    name: "üîí Secrets Scan - TruffleHog"
    needs: sca
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install TruffleHog
        run: pip install trufflehog

      - name: Run TruffleHog
        run: trufflehog filesystem . --json > trufflehog.json || true

      - uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog.json


  #----------------------------------------------------
  # 5) SBOM ‚Äî SYFT
  #----------------------------------------------------
  sbom:
    name: "üì¶ SBOM - Syft"
    needs: secrets
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: Generate SBOM
        run: syft dir:. -o json > sbom.json

      - uses: actions/upload-artifact@v4
        with:
          name: sbom-report
          path: sbom.json


  #----------------------------------------------------
  # 6) DOCKER IMAGE ‚Äî TRIVY SCAN
  #----------------------------------------------------
  docker_scan:
    name: "üê≥ Docker Scan - Trivy"
    needs: sbom
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t devsecops:latest .

      - name: Run Trivy on Docker Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "devsecops:latest"
          format: "json"
          output: "trivy.json"
          exit-code: "0"

      - uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy.json

#----------------------------------------------------
# 6-bis) PUSH DOCKER IMAGE TO DOCKER HUB
#----------------------------------------------------
docker_push:
  name: "üì§ Push Docker Image to Docker Hub"
  needs: docker_scan
  runs-on: ubuntu-latest

  steps:
    - uses: actions/checkout@v4

    - uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Build Docker Image
      run: docker build -t devsecops:latest .

    - name: Tag Docker Image
      run: docker tag devsecops:latest karimarouchi/devsecops:latest

    - name: Push Docker Image
      run: docker push karimarouchi/devsecops:latest

  #----------------------------------------------------
  # 7) DAST ‚Äî NIKTO
  #----------------------------------------------------
  dast:
    name: "üåê DAST - Nikto"
    needs: docker_scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Nikto
        run: |
          sudo apt update -qq
          sudo apt install -y nikto
          nikto -h http://testphp.vulnweb.com -o nikto.txt

      - uses: actions/upload-artifact@v4
        with:
          name: nikto-report
          path: nikto.txt


  #----------------------------------------------------
  # 8) QODANA ‚Äî STATIC ANALYSIS
  #----------------------------------------------------
  qodana:
    name: "üîé Qodana Cloud"
    needs: dast
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: JetBrains/qodana-action@v2025.2
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN_800884080 }}


  #----------------------------------------------------
  # 9) DASHBOARD HTML
  #----------------------------------------------------
  dashboard:
    name: "üìä Generate Security Dashboard"
    needs: [sast, build, sca, secrets, sbom, docker_scan, dast, qodana]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Organize reports
        run: |
          mkdir -p reports
          mv semgrep-report reports/ || true
          mv sca-report reports/ || true
          mv trufflehog-report reports/ || true
          mv sbom-report reports/ || true
          mv trivy-report reports/ || true
          mv nikto-report reports/ || true

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Generate dashboard HTML
        run: python scripts/generate_dashboard.py

      - uses: actions/upload-artifact@v4
        with:
          name: security-dashboard
          path: security-dashboard.html


  #----------------------------------------------------
  # 10) EMAIL NOTIFICATION
  #----------------------------------------------------
  notify_email:
    name: "üìß Pipeline Failure Email"
    needs: [dashboard]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® DevSecOps Pipeline Failed"
          body: "Une √©tape du pipeline DevSecOps a √©chou√©."
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
